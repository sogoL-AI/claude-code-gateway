# 22-Claude Code Gateway API接口详细设计规范

**文档版本**: V1.0.0  
**创建日期**: 2025-07-31  
**最后更新**: 2025-07-31  
**负责人**: Claude Code Gateway Team  
**数据基础**: 基于173个Claude CLI会话文件（22,968条消息）完整分析  

## 📋 文档概述

本文档基于对**173个真实Claude CLI会话文件**的深度分析，以**单一API接口为单位**详细设计每个API端点，确保与Claude CLI的**一对一或一对多映射关系**，并提供完整的CLI和API输出格式对比。
详细报告在： `/Users/Zhuanz/Projects/claude-code-gateway/docs/V1.0.0/10-需求研究/Claude-CLI-Output-Analysis/claude-cli-analyzer/final_report`

### 🎯 设计原则

1. **接口单一职责**: 每个API接口承担明确的单一功能
2. **映射关系明确**: 详细说明CLI命令与API的对应关系  
3. **格式完整对比**: 展示CLI原始输出和API标准化输出
4. **全面功能覆盖**: 覆盖已发现的26种输出类型和31种工具

### 📊 分析数据统计

- **CLI输出类型**: 26种（8基础 + 18详细）
- **工具类型**: 31种（14标准 + 17MCP）
- **消息样本**: 22,968条
- **停止原因**: 3种（tool_use, end_turn, stop_sequence）
- **响应字段**: 21个核心字段

---

### 统一响应格式标准

所有API接口使用以下标准响应格式：

```json
{
  "api_version": "v1",
  "timestamp": "2025-07-31T21:33:44Z",
  "session_id": "5b8642f5-7817-4d99-8b6d-4bf5f64eb71d",
  "request_id": "uuid-v4",
  "parent_uuid": "父消息UUID (可选)",
  "status": "success|streaming|error",
  
  "data": {
    "type": "26种输出类型之一",
    "subtype": "具体子类型",
    "content": "格式化内容",
    "metadata": {
      "model": "claude-sonnet-4-20250514",
      "cwd": "/current/working/directory", 
      "git_branch": "main",
      "usage": {
        "input_tokens": 1000,
        "output_tokens": 500,
        "total_tokens": 1500
      },
      "stop_reason": "end_turn|tool_use|stop_sequence"
    }
  },
  
  "cli_mapping": {
    "original_command": "原始CLI命令",
    "flags_used": ["使用的标志"],
    "output_format": "CLI原始输出格式"
  },
  
  "pagination": {
    "has_more": false,
    "next_cursor": null,
    "total_count": 1
  },
  
  "errors": []
}
```

---

## 🔥 核心会话管理接口

### 1. 会话创建接口

#### API接口规范
```yaml
接口名称: POST /api/v1/sessions
功能描述: 创建新的Claude会话
CLI映射: 一对多关系
```

#### CLI命令映射关系
```bash
# 映射的CLI命令 (一对多)
claude "Hello"                    # 直接对话
claude --model sonnet             # 指定模型
claude --permission-mode auto     # 指定权限模式
claude --add-dir /path            # 添加工作目录
claude --output-format json       # 指定输出格式
```

#### CLI原始输出格式
```json
# CLI原始输出 (基于真实分析数据)
{
  "parentUuid": null,
  "isSidechain": false,
  "userType": "external", 
  "cwd": "/Users/Zhuanz/Projects/claude-code-gateway",
  "sessionId": "5b8642f5-7817-4d99-8b6d-4bf5f64eb71d",
  "version": "1.0.61",
  "gitBranch": "main",
  "type": "assistant",
  "timestamp": "2025-07-31T21:33:44Z",
  "message": {
    "id": "msg_01VeQTZXPMgZp56Gs4DcQEdM",
    "type": "message", 
    "role": "assistant",
    "model": "claude-sonnet-4-20250514",
    "content": [
      {
        "type": "text",
        "text": "Hello! How can I help you today?"
      }
    ],
    "stop_reason": "end_turn",
    "usage": {
      "input_tokens": 10,
      "output_tokens": 12,
      "service_tier": "standard"
    }
  },
  "requestId": "req_011CRf7oTkjzJZtAPgxWZXoL",
  "uuid": "f4cd7784-e72f-4fd4-9326-bd7f1eadb17d"
}
```

#### API标准化输出格式
```json
{
  "api_version": "v1",
  "timestamp": "2025-07-31T21:33:44Z",
  "session_id": "5b8642f5-7817-4d99-8b6d-4bf5f64eb71d",
  "request_id": "req_011CRf7oTkjzJZtAPgxWZXoL",
  "parent_uuid": null,
  "status": "success",
  
  "data": {
    "type": "text",
    "subtype": "text_success_message",
    "content": "Hello! How can I help you today?",
    "metadata": {
      "model": "claude-sonnet-4-20250514",
      "cwd": "/Users/Zhuanz/Projects/claude-code-gateway",
      "git_branch": "main",
      "usage": {
        "input_tokens": 10,
        "output_tokens": 12,
        "total_tokens": 22
      },
      "stop_reason": "end_turn",
      "service_tier": "standard"
    }
  },
  
  "cli_mapping": {
    "original_command": "claude \"Hello\"",
    "flags_used": [],
    "output_format": "assistant_message"
  },
  
  "pagination": {
    "has_more": false,
    "next_cursor": null,
    "total_count": 1
  },
  
  "errors": []
}
```

#### 请求参数说明
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| prompt | string | 是 | - | 用户输入内容 |
| model | string | 否 | "claude-sonnet-4-20250514" | 模型名称 |
| permission_mode | string | 否 | "ask" | 权限模式: ask/auto/plan/bypass |
| cwd | string | 否 | 当前目录 | 工作目录路径 |
| git_branch | string | 否 | 当前分支 | Git分支名称 |
| output_format | string | 否 | "text" | 输出格式: text/json/stream-json |
| additional_directories | array | 否 | [] | 额外工作目录数组 |
| max_turns | integer | 否 | null | 最大轮次(非交互模式) |

#### 请求示例
```bash
# cURL请求示例
curl -X POST "https://api.claude-code-gateway.com/api/v1/sessions" \
  -H "Authorization: Bearer sk-ant-api03-xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "Hello, please help me create a Python function",
    "model": "claude-sonnet-4-20250514",
    "permission_mode": "auto",
    "cwd": "/Users/developer/project",
    "output_format": "json"
  }'
```

```javascript
// JavaScript请求示例
const response = await fetch('https://api.claude-code-gateway.com/api/v1/sessions', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer sk-ant-api03-xxx',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    prompt: "Hello, please help me create a Python function",
    model: "claude-sonnet-4-20250514", 
    permission_mode: "auto",
    cwd: "/Users/developer/project",
    output_format: "json"
  })
});
```

#### 返回参数说明
| 字段路径 | 类型 | 必返回 | 说明 |
|----------|------|--------|------|
| api_version | string | 是 | API版本号 |
| timestamp | string | 是 | 响应时间戳(ISO8601) |
| session_id | string | 是 | 会话唯一标识符 |
| request_id | string | 是 | 请求唯一标识符 |
| parent_uuid | string | 否 | 父消息UUID(用于对话链) |
| status | string | 是 | 响应状态: success/streaming/error |
| data.type | string | 是 | 内容类型(26种之一) |
| data.subtype | string | 否 | 具体子类型 |
| data.content | object | 是 | 格式化内容数据 |
| data.metadata.model | string | 是 | 使用的模型名称 |
| data.metadata.cwd | string | 是 | 当前工作目录 |
| data.metadata.git_branch | string | 否 | Git分支信息 |
| data.metadata.usage.input_tokens | integer | 是 | 输入token数 |
| data.metadata.usage.output_tokens | integer | 是 | 输出token数 |
| data.metadata.usage.total_tokens | integer | 是 | 总token数 |
| data.metadata.stop_reason | string | 是 | 停止原因: end_turn/tool_use/stop_sequence |
| cli_mapping.original_command | string | 是 | 对应的CLI命令 |
| cli_mapping.flags_used | array | 是 | 使用的CLI标志 |
| cli_mapping.output_format | string | 是 | CLI原始输出格式 |
| pagination.has_more | boolean | 是 | 是否有更多数据 |
| pagination.next_cursor | string | 否 | 下一页游标 |
| pagination.total_count | integer | 是 | 总数据条数 |
| errors | array | 是 | 错误信息数组(成功时为空) |

---

### 2. 会话继续接口

#### API接口规范
```yaml  
接口名称: POST /api/v1/sessions/{session_id}/continue
功能描述: 继续现有会话对话
CLI映射: 一对多关系
```

#### CLI命令映射关系
```bash
# 映射的CLI命令 (一对多)
claude -c "继续对话"              # 继续最近会话
claude --continue "新问题"        # 继续会话并提问
claude -r session-id "查询"       # 恢复指定会话
```

#### CLI原始输出格式
```json
# CLI原始输出格式 (继续会话)
{
  "parentUuid": "previous-message-uuid",
  "isSidechain": false,
  "userType": "external",
  "cwd": "/Users/Zhuanz/Projects/claude-code-gateway", 
  "sessionId": "5b8642f5-7817-4d99-8b6d-4bf5f64eb71d",
  "version": "1.0.61",
  "gitBranch": "main",
  "type": "assistant",
  "timestamp": "2025-07-31T21:35:00Z",
  "message": {
    "id": "msg_02VeQTZXPMgZp56Gs4DcQEdN",
    "type": "message",
    "role": "assistant", 
    "model": "claude-sonnet-4-20250514",
    "content": [
      {
        "type": "text",
        "text": "基于我们之前的对话，让我继续为您解答..."
      }
    ],
    "stop_reason": "end_turn",
    "usage": {
      "input_tokens": 150,
      "output_tokens": 45,
      "service_tier": "standard"
    }
  },
  "requestId": "req_012CRf7oTkjzJZtAPgxWZXoM",
  "uuid": "g5de8895-bb43-55e1-a5dd-4g7f2aed930e"
}
```

#### API标准化输出格式
```json
{
  "api_version": "v1", 
  "timestamp": "2025-07-31T21:35:00Z",
  "session_id": "5b8642f5-7817-4d99-8b6d-4bf5f64eb71d",
  "request_id": "req_012CRf7oTkjzJZtAPgxWZXoM",
  "parent_uuid": "previous-message-uuid",
  "status": "success",
  
  "data": {
    "type": "text",
    "subtype": "text_continuation",
    "content": "基于我们之前的对话，让我继续为您解答...",
    "metadata": {
      "model": "claude-sonnet-4-20250514",
      "cwd": "/Users/Zhuanz/Projects/claude-code-gateway",
      "git_branch": "main",
      "usage": {
        "input_tokens": 150,
        "output_tokens": 45,
        "total_tokens": 195
      },
      "stop_reason": "end_turn",
      "context_preserved": true
    }
  },
  
  "cli_mapping": {
    "original_command": "claude -c \"继续对话\"",
    "flags_used": ["-c", "--continue"],
    "output_format": "assistant_continuation"
  }
}
```

#### 请求参数说明
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| prompt | string | 是 | - | 新的用户输入内容 |
| preserve_context | boolean | 否 | true | 是否保持上下文 |
| max_tokens | integer | 否 | null | 最大输出token数 |
| temperature | float | 否 | null | 采样温度(0-1) |
| stream | boolean | 否 | false | 是否流式返回 |
| include_thinking | boolean | 否 | true | 是否包含思考过程 |

#### 请求示例
```bash
# cURL请求示例
curl -X POST "https://api.claude-code-gateway.com/api/v1/sessions/5b8642f5-7817-4d99-8b6d-4bf5f64eb71d/continue" \
  -H "Authorization: Bearer sk-ant-api03-xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "基于之前的讨论，请继续完善这个API设计方案",
    "preserve_context": true,
    "include_thinking": true
  }'
```

```javascript
// JavaScript请求示例
const sessionId = "5b8642f5-7817-4d99-8b6d-4bf5f64eb71d";
const response = await fetch(`https://api.claude-code-gateway.com/api/v1/sessions/${sessionId}/continue`, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer sk-ant-api03-xxx',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    prompt: "基于之前的讨论，请继续完善这个API设计方案",
    preserve_context: true,
    include_thinking: true
  })
});
```

#### 返回参数说明
| 字段路径 | 类型 | 必返回 | 说明 |
|----------|------|--------|------|
| api_version | string | 是 | API版本号 |
| timestamp | string | 是 | 响应时间戳(ISO8601) |
| session_id | string | 是 | 会话唯一标识符 |
| request_id | string | 是 | 请求唯一标识符 |
| parent_uuid | string | 是 | 父消息UUID(对话链关系) |
| status | string | 是 | 响应状态: success/streaming/error |
| data.type | string | 是 | 内容类型(26种之一) |
| data.subtype | string | 是 | 具体子类型: text_continuation |
| data.content | string | 是 | 继续对话的内容 |
| data.metadata.model | string | 是 | 使用的模型名称 |
| data.metadata.cwd | string | 是 | 当前工作目录 |
| data.metadata.git_branch | string | 否 | Git分支信息 |
| data.metadata.usage.input_tokens | integer | 是 | 输入token数 |
| data.metadata.usage.output_tokens | integer | 是 | 输出token数 |
| data.metadata.usage.total_tokens | integer | 是 | 总token数 |
| data.metadata.stop_reason | string | 是 | 停止原因: end_turn/tool_use/stop_sequence |
| data.metadata.context_preserved | boolean | 是 | 上下文是否已保持 |
| cli_mapping.original_command | string | 是 | 对应的CLI命令 |
| cli_mapping.flags_used | array | 是 | 使用的CLI标志 |
| cli_mapping.output_format | string | 是 | CLI原始输出格式 |
| pagination | object | 否 | 分页信息(单次对话通常为null) |
| errors | array | 是 | 错误信息数组(成功时为空) |

---

### 3. 可恢复会话列表接口

#### API接口规范
```yaml
接口名称: GET /api/v1/sessions/resumable
功能描述: 获取可恢复的会话列表
CLI映射: 一对一关系
```

#### CLI命令映射关系
```bash
# 映射的CLI命令 (一对一)
claude --resume                   # 显示可恢复会话列表
```

#### CLI原始输出格式
```text
# CLI原始输出 (文本格式)
Available sessions to resume:

1. Session: 5b8642f5-7817-4d99-8b6d-4bf5f64eb71d
   Last message: "API设计方案已完成并写入指定文档！"
   Project: claude-code-gateway
   Branch: main
   Time: 2025-07-31 21:25:00

2. Session: 33388ab0-8873-4c26-93ba-ea978b2f0f7e  
   Last message: "🎉 Claude CLI输出格式研究项目圆满完成！"
   Project: claude-code-gateway
   Branch: main
   Time: 2025-07-31 20:44:41

3. Session: 82ff90b6-83f0-4fd7-80ae-c9fd872fe03c
   Last message: "任务已完成，代码已成功运行"
   Project: claude-code-gateway  
   Branch: develop
   Time: 2025-07-31 18:30:15

Select a session number to resume or press Ctrl+C to cancel:
```

#### API标准化输出格式
```json
{
  "api_version": "v1",
  "timestamp": "2025-07-31T21:33:44Z", 
  "session_id": null,
  "request_id": "req_013CRf7oTkjzJZtAPgxWZXoN",
  "status": "success",
  
  "data": {
    "type": "session_list",
    "subtype": "resumable_sessions",
    "content": {
      "total_sessions": 3,
      "sessions": [
        {
          "session_id": "5b8642f5-7817-4d99-8b6d-4bf5f64eb71d",
          "last_message": "API设计方案已完成并写入指定文档！",
          "last_message_preview": "API设计方案已完成并写入指定文档！...",
          "project": "claude-code-gateway",
          "git_branch": "main",
          "cwd": "/Users/Zhuanz/Projects/claude-code-gateway",
          "last_activity": "2025-07-31T21:25:00Z",
          "message_count": 42,
          "can_resume": true
        },
        {
          "session_id": "33388ab0-8873-4c26-93ba-ea978b2f0f7e",
          "last_message": "🎉 Claude CLI输出格式研究项目圆满完成！",
          "last_message_preview": "🎉 Claude CLI输出格式研究项目圆满完成！...",
          "project": "claude-code-gateway", 
          "git_branch": "main",
          "cwd": "/Users/Zhuanz/Projects/claude-code-gateway",
          "last_activity": "2025-07-31T20:44:41Z",
          "message_count": 18,
          "can_resume": true
        },
        {
          "session_id": "82ff90b6-83f0-4fd7-80ae-c9fd872fe03c",
          "last_message": "任务已完成，代码已成功运行",
          "last_message_preview": "任务已完成，代码已成功运行",
          "project": "claude-code-gateway",
          "git_branch": "develop", 
          "cwd": "/Users/Zhuanz/Projects/claude-code-gateway",
          "last_activity": "2025-07-31T18:30:15Z",
          "message_count": 8,
          "can_resume": true
        }
      ]
    },
    "metadata": {
      "sort_by": "last_activity",
      "sort_order": "desc",
      "filter_criteria": "resumable_only"
    }
  },
  
  "cli_mapping": {
    "original_command": "claude --resume",
    "flags_used": ["--resume"],
    "output_format": "session_selection_menu"
  },
  
  "pagination": {
    "has_more": false,
    "next_cursor": null,
    "total_count": 3
  }
}
```

#### 请求参数说明
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| limit | integer | 否 | 10 | 返回的会话数量限制 |
| offset | integer | 否 | 0 | 偏移量(分页使用) |
| sort_by | string | 否 | "last_activity" | 排序字段: last_activity/created_at/message_count |
| sort_order | string | 否 | "desc" | 排序方式: desc/asc |
| project_filter | string | 否 | null | 按项目名过滤 |
| branch_filter | string | 否 | null | 按Git分支过滤 |
| include_inactive | boolean | 否 | false | 是否包含非活跃会话 |

#### 请求示例
```bash
# cURL请求示例
curl -X GET "https://api.claude-code-gateway.com/api/v1/sessions/resumable?limit=5&sort_by=last_activity&sort_order=desc" \
  -H "Authorization: Bearer sk-ant-api03-xxx" \
  -H "Content-Type: application/json"
```

```javascript
// JavaScript请求示例
const params = new URLSearchParams({
  limit: '5',
  sort_by: 'last_activity',
  sort_order: 'desc',
  project_filter: 'claude-code-gateway'
});

const response = await fetch(`https://api.claude-code-gateway.com/api/v1/sessions/resumable?${params}`, {
  method: 'GET',
  headers: {
    'Authorization': 'Bearer sk-ant-api03-xxx',
    'Content-Type': 'application/json'
  }
});
```

#### 返回参数说明
| 字段路径 | 类型 | 必返回 | 说明 |
|----------|------|--------|------|
| api_version | string | 是 | API版本号 |
| timestamp | string | 是 | 响应时间戳(ISO8601) |
| session_id | null | 是 | 列表接口返回null |
| request_id | string | 是 | 请求唯一标识符 |
| status | string | 是 | 响应状态: success/error |
| data.type | string | 是 | 内容类型: session_list |
| data.subtype | string | 是 | 子类型: resumable_sessions |
| data.content.total_sessions | integer | 是 | 可恢复会话总数 |
| data.content.sessions | array | 是 | 会话列表数组 |
| data.content.sessions[].session_id | string | 是 | 会话唯一标识符 |
| data.content.sessions[].last_message | string | 是 | 最后一条消息内容 |
| data.content.sessions[].last_message_preview | string | 是 | 消息预览(截断) |
| data.content.sessions[].project | string | 是 | 所属项目名称 |
| data.content.sessions[].git_branch | string | 否 | Git分支名称 |
| data.content.sessions[].cwd | string | 是 | 工作目录路径 |
| data.content.sessions[].last_activity | string | 是 | 最后活动时间(ISO8601) |
| data.content.sessions[].message_count | integer | 是 | 会话消息数量 |
| data.content.sessions[].can_resume | boolean | 是 | 是否可以恢复 |
| data.metadata.sort_by | string | 是 | 实际使用的排序字段 |
| data.metadata.sort_order | string | 是 | 实际排序方式 |
| data.metadata.filter_criteria | string | 是 | 过滤条件 |
| cli_mapping.original_command | string | 是 | 对应的CLI命令 |
| cli_mapping.flags_used | array | 是 | 使用的CLI标志 |
| cli_mapping.output_format | string | 是 | CLI原始输出格式 |
| pagination.has_more | boolean | 是 | 是否有更多数据 |
| pagination.next_cursor | string | 否 | 下一页游标 |
| pagination.total_count | integer | 是 | 总数据条数 |
| errors | array | 是 | 错误信息数组(成功时为空) |
